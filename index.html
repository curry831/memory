<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ”¿æ²»ä¸è‹±è¯­èƒŒè¯µåŠ©æ‰‹</title>
<script>
  // æ³¨å†Œ Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ: ', registration.scope);
        })
        .catch(err => {
          console.log('ServiceWorker æ³¨å†Œå¤±è´¥: ', err);
        });
    });
  }
  
  // æ·»åŠ å®‰è£…æç¤º
  let deferredPrompt;
  
  window.addEventListener('beforeinstallprompt', (e) => {
    // é˜»æ­¢é»˜è®¤çš„å®‰è£…æç¤º
    e.preventDefault();
    // ä¿å­˜äº‹ä»¶ä»¥ä¾¿ç¨åè§¦å‘
    deferredPrompt = e;
    
    // æ˜¾ç¤ºä¸€ä¸ªè‡ªå®šä¹‰çš„å®‰è£…æŒ‰é’®
    const installButton = document.createElement('button');
    installButton.textContent = 'ğŸ“± å®‰è£…åº”ç”¨';
    installButton.style.position = 'fixed';
    installButton.style.bottom = '20px';
    installButton.style.left = '20px';
    installButton.style.padding = '10px 15px';
    installButton.style.backgroundColor = '#6366f1';
    installButton.style.color = 'white';
    installButton.style.border = 'none';
    installButton.style.borderRadius = '5px';
    installButton.style.cursor = 'pointer';
    installButton.style.zIndex = '1000';
    installButton.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
    installButton.style.fontSize = '14px';
    
    installButton.addEventListener('click', () => {
      // éšè—æŒ‰é’®
      installButton.style.display = 'none';
      // æ˜¾ç¤ºå®‰è£…æç¤º
      deferredPrompt.prompt();
      // ç­‰å¾…ç”¨æˆ·å“åº”
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…');
        } else {
          console.log('ç”¨æˆ·å–æ¶ˆäº†å®‰è£…');
        }
        deferredPrompt = null;
      });
    });
    
    document.body.appendChild(installButton);
  });
</script>
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6366f1">
<style>
/* åŸºç¡€æ ·å¼é‡ç½® */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-color: #2563eb;
    --secondary-color: #7c3aed;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --dark-bg: #1f2937;
    --light-bg: #f3f4f6;
    --card-bg: #ffffff;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

body {
    font-family: 'Noto Sans SC', sans-serif;
    background-color: #f9fafb;
    color: #1f2937;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* å®¹å™¨æ ·å¼ */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

@media (min-width: 640px) {
    .container {
        padding: 0 1.5rem;
    }
}

@media (min-width: 1024px) {
    .container {
        padding: 0 2rem;
    }
}

/* ç™»å½•å®¹å™¨ */
.login-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 1000;
}

.login-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 2rem;
    width: 100%;
    max-width: 28rem;
    margin: 1rem;
}

/* åº”ç”¨å®¹å™¨ */
.app-container {
    display: none;
    min-height: 100vh;
    background-color: #f9fafb;
}

/* è¡¨å•æ ·å¼ */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.25rem;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 1rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 2.5rem;
}

/* æŒ‰é’®æ ·å¼ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

.btn-primary {
    background-color: #6366f1;
    color: white;
}

.btn-primary:hover {
    background-color: #5558e3;
}

.btn-secondary {
    background-color: #10b981;
    color: white;
}

.btn-secondary:hover {
    background-color: #0ea968;
}

.btn-danger {
    background-color: #ef4444;
    color: white;
}

.btn-danger:hover {
    background-color: #dc2626;
}

.btn-full {
    width: 100%;
}

/* å¡ç‰‡æ ·å¼ */
.card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

/* å¤´éƒ¨æ ·å¼ */
.header {
    background: white;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.user-name {
    font-weight: 500;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.header-btn {
    background: none;
    border: none;
    color: #3b82f6;
    cursor: pointer;
    font-size: 0.875rem;
    text-decoration: none;
}

.header-btn:hover {
    color: #2563eb;
}

.header-btn.danger {
    color: #ef4444;
}

.header-btn.danger:hover {
    color: #dc2626;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 1.5rem;
    width: 100%;
    max-width: 32rem;
    max-height: 80vh;
    overflow-y: auto;
    margin: 1rem;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

.modal-close:hover {
    color: #374151;
}

/* åŠ è½½åŠ¨ç”» */
.loading {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #f3f4f6;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* æç¤ºæ¶ˆæ¯ */
.toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background-color: #10b981;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.375rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    opacity: 0;
    transition: all 0.3s ease-in-out;
    z-index: 2000;
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* åŒæ­¥çŠ¶æ€ */
.sync-status {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    display: none;
    z-index: 1000;
}

.sync-status.show {
    display: block;
}

/* éšè—ç±» */
.hidden {
    display: none !important;
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ä¸»å†…å®¹åŒºåŸŸæ ·å¼ */
.main-content {
    display: grid;
    grid-template-columns: 250px 1fr 300px;
    gap: 20px;
    padding: 20px;
    min-height: 600px;
}

.sidebar {
    background: var(--light-bg);
    border-radius: 12px;
    padding: 20px;
    height: fit-content;
    position: sticky;
    top: 90px;
}

.add-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, var(--success-color), #059669);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-bottom: 20px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.add-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.search-box {
    width: 100%;
    padding: 10px 15px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    margin-bottom: 20px;
    transition: border-color 0.3s;
}

.search-box:focus {
    outline: none;
    border-color: var(--primary-color);
}

.category-list {
    list-style: none;
}

.category-item {
    padding: 12px 15px;
    margin-bottom: 5px;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.category-item:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow);
}

.category-item.active {
    background: var(--primary-color);
    color: white;
}

.category-count {
    background: var(--light-bg);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.category-item.active .category-count {
    background: rgba(255, 255, 255, 0.3);
}

.category-item.custom {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 2px solid #fbbf24;
}

.category-item.custom.active {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.delete-category {
    opacity: 0;
    transition: opacity 0.3s;
    cursor: pointer;
    margin-left: 10px;
}

.category-item:hover .delete-category {
    opacity: 1;
}

.content-area {
    background: white;
    border-radius: 12px;
    padding: 30px;
    overflow-y: auto;
    max-height: 700px;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

.content-title {
    font-size: 1.5rem;
    color: var(--text-primary);
    font-weight: 600;
}

.view-toggle {
    display: flex;
    gap: 10px;
}

.view-btn {
    padding: 8px 15px;
    border: 1px solid var(--border-color);
    background: white;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s;
}

.view-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.card-container {
    display: grid;
    gap: 20px;
}

.memory-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 25px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.memory-card.custom {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.memory-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.memory-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.card-number {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
}

.card-question {
    font-size: 1.2rem;
    margin-bottom: 15px;
    font-weight: 600;
}

.card-answer {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    line-height: 1.6;
    display: none;
}

.card-answer.show {
    display: block;
    animation: fadeIn 0.3s;
}

.list-view {
    display: none;
}

.list-item {
    background: var(--light-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.list-item.custom {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    border: 2px solid #10b981;
}

.list-item:hover {
    background: var(--border-color);
    transform: translateX(5px);
}

.list-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.list-item-title {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 1.1rem;
}

.list-item-content {
    color: var(--text-secondary);
    line-height: 1.6;
    display: none;
}

.list-item.expanded .list-item-content {
    display: block;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

.action-buttons {
    display: flex;
    gap: 10px;
}

.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    color: var(--text-secondary);
    transition: color 0.3s;
}

.action-btn:hover {
    color: var(--primary-color);
}

.action-btn.favorited {
    color: var(--danger-color);
}

.action-btn.delete {
    color: var(--danger-color);
}

.right-panel {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.progress-card {
    background: var(--light-bg);
    border-radius: 12px;
    padding: 20px;
}

.progress-title {
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--text-primary);
}

.progress-bar {
    background: var(--border-color);
    height: 10px;
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success-color), var(--primary-color));
    border-radius: 5px;
    transition: width 0.5s ease;
}

.progress-text {
    text-align: center;
    color: var(--text-secondary);
    font-size: 14px;
}

.favorites-list {
    background: var(--light-bg);
    border-radius: 12px;
    padding: 20px;
    max-height: 300px;
    overflow-y: auto;
}

.favorite-item {
    padding: 10px;
    background: white;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.favorite-item:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow);
}

.floating-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    transition: all 0.3s;
    z-index: 1000;
}

.floating-button:hover {
    transform: scale(1.1);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
    .main-content {
        grid-template-columns: 1fr;
    }

    .sidebar, .right-panel {
        position: static;
    }
}

@media (max-width: 640px) {
    .header-content {
        flex-direction: column;
        text-align: center;
    }

    h1 {
        font-size: 1.5rem;
    }

    .stats {
        width: 100%;
        justify-content: space-around;
    }
    
    .modal-content {
        margin: 0.5rem;
        max-height: 90vh;
    }
    
    .list-item-header {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .action-buttons {
        align-self: flex-end;
    }
}
</style>
</head>
<body>
<!-- åŠ è½½é®ç½© -->
<div id="loading-overlay" class="loading-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; z-index: 9999;">
    <div style="text-align: center;">
        <div class="loading"></div>
        <p style="margin-top: 0.5rem; color: #374151;">æ­£åœ¨åˆå§‹åŒ–åº”ç”¨...</p>
        <p id="loading-status" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;"></p>
    </div>
</div>

<!-- ç™»å½•ç•Œé¢ -->
<div id="login-container" class="login-container">
    <div class="login-card">
        <h2 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem;">ğŸ“š æ”¿æ²»ä¸è‹±è¯­èƒŒè¯µåŠ©æ‰‹</h2>
        
        <form id="login-form">
            <div class="form-group">
                <label for="username" class="form-label">ç”¨æˆ·å</label>
                <input type="text" id="username" class="form-input" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å" required>
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">å¯†ç </label>
                <input type="password" id="password" class="form-input" placeholder="è¾“å…¥æ‚¨çš„å¯†ç " required>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; font-size: 0.875rem; color: #6b7280;">
                    <input type="checkbox" id="use-local" style="margin-right: 0.5rem;">
                    ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
                </label>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" id="login-btn">
                <span id="login-text">ç™»å½•</span>
                <div id="login-spinner" class="loading" style="display: none; margin-left: 0.5rem;"></div>
            </button>
            
            <p style="text-align: center; font-size: 0.875rem; color: #6b7280; margin-top: 1rem;">
                é¦–æ¬¡ä½¿ç”¨å°†è‡ªåŠ¨åˆ›å»ºè´¦æˆ·
            </p>
        </form>
    </div>
</div>

<!-- ä¸»åº”ç”¨ç•Œé¢ -->
<div id="app-container" class="app-container">
    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="user-info">
                    <span>ç”¨æˆ·:</span>
                    <span id="current-user" class="user-name"></span>
                </div>
                <div class="header-actions">
                    <button id="sync-btn" class="header-btn">
                        <div id="sync-spinner" class="loading" style="display: none; margin-right: 0.25rem;"></div>
                        <span id="sync-text">æ‰‹åŠ¨åŒæ­¥</span>
                    </button>
                    <button id="export-btn" class="header-btn">å¯¼å‡ºæ•°æ®</button>
                    <button id="logout-btn" class="header-btn danger">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container" style="padding-top: 1.5rem; padding-bottom: 3rem;">
        <!-- æ ‡é¢˜ -->
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1 style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">ğŸ“š æ”¿æ²»ä¸è‹±è¯­èƒŒè¯µåŠ©æ‰‹</h1>
            <p style="color: #6b7280;">è®°å½•ä½ çš„æ¯ä¸€ç‚¹è¿›æ­¥</p>
        </div>

        <!-- æ¨¡å¼åˆ‡æ¢ -->
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <div class="mode-switcher" style="display: inline-flex; gap: 10px; background: rgba(255, 255, 255, 0.2); padding: 5px; border-radius: 10px;">
                <button class="mode-btn active" id="politics-mode-btn" onclick="switchMode('politics')">æ”¿æ²»åˆ†æ</button>
                <button class="mode-btn" id="english-mode-btn" onclick="switchMode('english')">è‹±è¯­ä½œæ–‡</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <section style="margin-bottom: 1.5rem;">
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="stat-card" style="background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); padding: 1rem; text-align: center;">
                    <div class="stat-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">æ€»é¢˜ç›®</div>
                    <div id="total-items" class="stat-value" style="font-size: 1.5rem; font-weight: 700; color: #6366f1;">0</div>
                </div>
                <div class="stat-card" style="background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); padding: 1rem; text-align: center;">
                    <div class="stat-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">å·²å­¦ä¹ </div>
                    <div id="learned-items" class="stat-value" style="font-size: 1.5rem; font-weight: 700; color: #10b981;">0</div>
                </div>
                <div class="stat-card" style="background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); padding: 1rem; text-align: center;">
                    <div class="stat-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">å·²æ”¶è—</div>
                    <div id="favorite-items" class="stat-value" style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">0</div>
                </div>
                <div class="stat-card" style="background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); padding: 1rem; text-align: center;">
                    <div class="stat-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">å­¦ä¹ è¿›åº¦</div>
                    <div id="progress-percent" class="stat-value" style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">0%</div>
                </div>
            </div>
        </section>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¦ä¾§è¾¹æ  -->
            <aside class="sidebar">
                <button class="add-btn" onclick="openAddModal()">
                    <span>â•</span>
                    <span>æ·»åŠ æ–°é¢˜ç›®</span>
                </button>
                <input type="text" class="search-box" placeholder="æœç´¢é¢˜ç›®..." onkeyup="searchItems(this.value)">
                <ul class="category-list" id="category-list">
                    <!-- Categories will be dynamically generated -->
                </ul>
            </aside>

            <!-- ä¸­é—´å†…å®¹åŒº -->
            <section class="content-area">
                <div class="content-header">
                    <h2 class="content-title" id="content-title">å…¨éƒ¨é¢˜ç›®</h2>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="toggleView('card')">å¡ç‰‡æ¨¡å¼</button>
                        <button class="view-btn" onclick="toggleView('list')">åˆ—è¡¨æ¨¡å¼</button>
                    </div>
                </div>
                <div class="card-container" id="card-view">
                    <!-- Cards will be dynamically generated -->
                </div>
                <div class="list-view" id="list-view">
                    <!-- List items will be dynamically generated -->
                </div>
            </section>

            <!-- å³ä¾§é¢æ¿ -->
            <aside class="right-panel">
                <div class="progress-card">
                    <h3 class="progress-title">å­¦ä¹ è¿›åº¦</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0% å®Œæˆ</div>
                </div>
                <div class="favorites-list">
                    <h3 class="progress-title">æ”¶è—å¤¹</h3>
                    <div id="favorites-container">
                        <!-- Favorites will be dynamically generated -->
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="add-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">æ·»åŠ æ–°é¢˜ç›®</h3>
            <button class="modal-close" id="close-modal-btn">&times;</button>
        </div>
        <form id="add-form">
            <div class="form-group">
                <label class="form-label">é¢˜ç›®ç±»å‹</label>
                <select class="form-input" id="item-type" onchange="updateCategoryOptions()">
                    <option value="politics">æ”¿æ²»åˆ†æ</option>
                    <option value="english">è‹±è¯­ä½œæ–‡</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">åˆ†ç±»</label>
                <select class="form-input" id="item-category">
                    <option value="">é€‰æ‹©åˆ†ç±»</option>
                    <option value="new">+ æ–°å»ºåˆ†ç±»</option>
                </select>
                <input type="text" class="form-input" id="new-category" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°" style="display: none; margin-top: 10px;">
            </div>
            <div class="form-group">
                <label class="form-label">é—®é¢˜/æ ‡é¢˜</label>
                <input type="text" class="form-input" id="item-question" required placeholder="è¾“å…¥é—®é¢˜æˆ–æ ‡é¢˜">
            </div>
            <div class="form-group">
                <label class="form-label">ç­”æ¡ˆ/å†…å®¹</label>
                <textarea class="form-input form-textarea" id="item-answer" required placeholder="è¾“å…¥ç­”æ¡ˆæˆ–å†…å®¹" rows="6"></textarea>
            </div>
            <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" style="background-color: #e5e7eb; color: #374151;" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
<div id="export-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">å¯¼å‡ºæ•°æ®</h3>
            <button class="modal-close" id="close-export-modal-btn">&times;</button>
        </div>
        <div id="export-options">
            <!-- Options will be dynamically generated -->
        </div>
    </div>
</div>

<!-- æç¤ºæ¶ˆæ¯ -->
<div id="toast" class="toast">
    <span id="toast-text"></span>
</div>

<!-- åŒæ­¥çŠ¶æ€ -->
<div id="sync-status" class="sync-status">
    <span id="sync-status-text">åŒæ­¥ä¸­...</span>
</div>

<!-- éšæœºå¤ä¹ æŒ‰é’® -->
<div class="floating-button" onclick="randomReview()">
    ğŸ²
</div>

<script>
// Firebase é…ç½® - è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„é…ç½®
const firebaseConfig = {
    apiKey: "AIzaSyBPLuMktx7vBuqmh6KzIyRlNHK4yh4j5OY",
    authDomain: "words-43d1b.firebaseapp.com",
    databaseURL: "https://words-43d1b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "words-43d1b",
    storageBucket: "words-43d1b.firebasestorage.app",
    messagingSenderId: "992209854334",
    appId: "1:992209854334:web:e862a34544b49a243e1d2f",
    measurementId: "G-982EDQG7X0"
};

// é»˜è®¤æ•°æ®
const defaultData = {
    politics: {
        categories: {
            'é©¬å…‹æ€ä¸»ä¹‰åŸºæœ¬åŸç†': [
                {
                    id: 'pol1',
                    question: 'ç®€è¿°é©¬å…‹æ€ä¸»ä¹‰çš„ä¸‰ä¸ªåŸºæœ¬ç»„æˆéƒ¨åˆ†',
                    answer: 'é©¬å…‹æ€ä¸»ä¹‰çš„ä¸‰ä¸ªåŸºæœ¬ç»„æˆéƒ¨åˆ†æ˜¯ï¼š1. é©¬å…‹æ€ä¸»ä¹‰å“²å­¦ï¼ˆè¾©è¯å”¯ç‰©ä¸»ä¹‰å’Œå†å²å”¯ç‰©ä¸»ä¹‰ï¼‰ï¼›2. é©¬å…‹æ€ä¸»ä¹‰æ”¿æ²»ç»æµå­¦ï¼›3. ç§‘å­¦ç¤¾ä¼šä¸»ä¹‰ã€‚è¿™ä¸‰ä¸ªç»„æˆéƒ¨åˆ†æœ‰æœºç»Ÿä¸€ï¼Œæ„æˆäº†å®Œæ•´çš„é©¬å…‹æ€ä¸»ä¹‰ç†è®ºä½“ç³»ã€‚'
                },
                {
                    id: 'pol2',
                    question: 'ä»€ä¹ˆæ˜¯çŸ›ç›¾çš„åŒä¸€æ€§å’Œæ–—äº‰æ€§ï¼Ÿ',
                    answer: 'çŸ›ç›¾çš„åŒä¸€æ€§æ˜¯æŒ‡çŸ›ç›¾åŒæ–¹ç›¸äº’ä¾å­˜ã€ç›¸äº’è´¯é€šçš„æ€§è´¨å’Œè¶‹åŠ¿ã€‚çŸ›ç›¾çš„æ–—äº‰æ€§æ˜¯æŒ‡çŸ›ç›¾åŒæ–¹ç›¸äº’æ’æ–¥ã€ç›¸äº’å¯¹ç«‹çš„æ€§è´¨ã€‚åŒä¸€æ€§æ˜¯ç›¸å¯¹çš„ï¼Œæ–—äº‰æ€§æ˜¯ç»å¯¹çš„ï¼ŒäºŒè€…å…±åŒæ¨åŠ¨äº‹ç‰©å‘å±•ã€‚'
                }
            ],
            'æ¯›æ³½ä¸œæ€æƒ³': [
                {
                    id: 'pol3',
                    question: 'æ¯›æ³½ä¸œæ€æƒ³æ´»çš„çµé­‚æ˜¯ä»€ä¹ˆï¼Ÿ',
                    answer: 'æ¯›æ³½ä¸œæ€æƒ³æ´»çš„çµé­‚æ˜¯ï¼šå®äº‹æ±‚æ˜¯ã€ç¾¤ä¼—è·¯çº¿ã€ç‹¬ç«‹è‡ªä¸»ã€‚è¿™ä¸‰ä¸ªæ–¹é¢ç›¸äº’è”ç³»ã€ä¸å¯åˆ†å‰²ï¼Œè´¯ç©¿äºæ¯›æ³½ä¸œæ€æƒ³çš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼Œæ˜¯ä¸­å›½å…±äº§å…šäººå¿…é¡»å§‹ç»ˆåšæŒçš„ç«‹åœºã€è§‚ç‚¹å’Œæ–¹æ³•ã€‚'
                },
                {
                    id: 'pol4',
                    question: 'ç®€è¿°æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½ç†è®ºçš„ä¸»è¦å†…å®¹',
                    answer: 'æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½ç†è®ºçš„ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š1. é©å‘½çš„å¯¹è±¡æ˜¯å¸å›½ä¸»ä¹‰ã€å°å»ºä¸»ä¹‰å’Œå®˜åƒšèµ„æœ¬ä¸»ä¹‰ï¼›2. é©å‘½çš„åŠ¨åŠ›åŒ…æ‹¬å·¥äººé˜¶çº§ã€å†œæ°‘é˜¶çº§ã€åŸå¸‚å°èµ„äº§é˜¶çº§å’Œæ°‘æ—èµ„äº§é˜¶çº§ï¼›3. é©å‘½çš„é¢†å¯¼æƒå¿…é¡»æŒæ¡åœ¨æ— äº§é˜¶çº§æ‰‹ä¸­ï¼›4. é©å‘½çš„é“è·¯æ˜¯å†œæ‘åŒ…å›´åŸå¸‚ã€æ­¦è£…å¤ºå–æ”¿æƒã€‚'
                }
            ],
            'ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ç†è®º': [
                {
                    id: 'pol5',
                    question: 'ç®€è¿°ä¹ è¿‘å¹³æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰æ€æƒ³çš„æ ¸å¿ƒå†…å®¹',
                    answer: 'ä¹ è¿‘å¹³æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰æ€æƒ³çš„æ ¸å¿ƒå†…å®¹æ˜¯"å…«ä¸ªæ˜ç¡®"å’Œ"åå››ä¸ªåšæŒ"ã€‚"å…«ä¸ªæ˜ç¡®"å›ç­”äº†æ–°æ—¶ä»£åšæŒå’Œå‘å±•ä»€ä¹ˆæ ·çš„ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰çš„é—®é¢˜ï¼Œ"åå››ä¸ªåšæŒ"å›ç­”äº†æ–°æ—¶ä»£æ€æ ·åšæŒå’Œå‘å±•ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰çš„é—®é¢˜ã€‚'
                },
                {
                    id: 'pol6',
                    question: 'ä»€ä¹ˆæ˜¯æ–°å‘å±•ç†å¿µï¼Ÿ',
                    answer: 'æ–°å‘å±•ç†å¿µæ˜¯æŒ‡åˆ›æ–°ã€åè°ƒã€ç»¿è‰²ã€å¼€æ”¾ã€å…±äº«çš„å‘å±•ç†å¿µã€‚åˆ›æ–°æ˜¯å¼•é¢†å‘å±•çš„ç¬¬ä¸€åŠ¨åŠ›ï¼Œåè°ƒæ˜¯æŒç»­å¥åº·å‘å±•çš„å†…åœ¨è¦æ±‚ï¼Œç»¿è‰²æ˜¯æ°¸ç»­å‘å±•çš„å¿…è¦æ¡ä»¶ï¼Œå¼€æ”¾æ˜¯å›½å®¶ç¹è£å‘å±•çš„å¿…ç”±ä¹‹è·¯ï¼Œå…±äº«æ˜¯ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰çš„æœ¬è´¨è¦æ±‚ã€‚'
                }
            ],
            'æ—¶äº‹æ”¿æ²»': [
                {
                    id: 'pol7',
                    question: 'ç®€è¿°ä¸­å›½å¼ç°ä»£åŒ–çš„äº”ä¸ªç‰¹å¾',
                    answer: 'ä¸­å›½å¼ç°ä»£åŒ–çš„äº”ä¸ªç‰¹å¾æ˜¯ï¼š1. äººå£è§„æ¨¡å·¨å¤§çš„ç°ä»£åŒ–ï¼›2. å…¨ä½“äººæ°‘å…±åŒå¯Œè£•çš„ç°ä»£åŒ–ï¼›3. ç‰©è´¨æ–‡æ˜å’Œç²¾ç¥æ–‡æ˜ç›¸åè°ƒçš„ç°ä»£åŒ–ï¼›4. äººä¸è‡ªç„¶å’Œè°å…±ç”Ÿçš„ç°ä»£åŒ–ï¼›5. èµ°å’Œå¹³å‘å±•é“è·¯çš„ç°ä»£åŒ–ã€‚'
                },
                {
                    id: 'pol8',
                    question: 'ä»€ä¹ˆæ˜¯"ä¸¤ä¸ªç¡®ç«‹"çš„å†³å®šæ€§æ„ä¹‰ï¼Ÿ',
                    answer: '"ä¸¤ä¸ªç¡®ç«‹"æ˜¯æŒ‡ç¡®ç«‹ä¹ è¿‘å¹³åŒå¿—å…šä¸­å¤®çš„æ ¸å¿ƒã€å…¨å…šçš„æ ¸å¿ƒåœ°ä½ï¼Œç¡®ç«‹ä¹ è¿‘å¹³æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰æ€æƒ³çš„æŒ‡å¯¼åœ°ä½ã€‚è¿™æ˜¯å…šçš„åå…«å¤§ä»¥æ¥æœ€é‡è¦çš„æ”¿æ²»æˆæœï¼Œæ˜¯æ¨åŠ¨å…šå’Œå›½å®¶äº‹ä¸šå–å¾—å†å²æ€§æˆå°±ã€å‘ç”Ÿå†å²æ€§å˜é©çš„å†³å®šæ€§å› ç´ ã€‚'
                }
            ]
        }
    },
    english: {
        categories: {
            'è®®è®ºæ–‡æ¨¡æ¿': [
                {
                    id: 'eng1',
                    question: 'Argumentative Essay Structure',
                    answer: 'Introduction: Hook + Background + Thesis Statement\nBody Paragraph 1: Topic sentence + Evidence + Analysis + Link\nBody Paragraph 2: Topic sentence + Evidence + Analysis + Link\nBody Paragraph 3: Counterargument + Rebuttal\nConclusion: Restate thesis + Summarize points + Final thought'
                },
                {
                    id: 'eng2',
                    question: 'Advantages and Disadvantages Essay',
                    answer: 'Paragraph 1: Introduction - State the topic and mention both sides\nParagraph 2: Advantages - Present 2-3 benefits with examples\nParagraph 3: Disadvantages - Present 2-3 drawbacks with examples\nParagraph 4: Conclusion - Summarize and give your opinion'
                }
            ],
            'å›¾è¡¨ä½œæ–‡æ¨¡æ¿': [
                {
                    id: 'eng3',
                    question: 'Line Graph Description',
                    answer: 'Opening: "The line graph illustrates/compares/shows..."\nOverall trend: "Overall, it is clear that..."\nSpecific details: "In the beginning period, ... remained stable at..."\n"Subsequently, there was a dramatic increase/decrease..."\n"By the end of the period, ... had reached..."\nConclusion: Summarize main trends'
                },
                {
                    id: 'eng4',
                    question: 'Pie Chart Description',
                    answer: 'Opening: "The pie chart shows the proportion of..."\nMajor segments: "The largest segment is..., accounting for...%"\nComparison: "In contrast, ... represents only...%"\nMinor segments: "Other categories make up the remaining...%"\nConclusion: "Overall, ... dominates the chart, while... plays a minimal role"'
                }
            ],
            'ä¿¡ä»¶æ¨¡æ¿': [
                {
                    id: 'eng5',
                    question: 'Formal Letter Structure',
                    answer: 'Your Address\nDate\nRecipient\'s Address\nDear Sir/Madam,\n\nParagraph 1: State the purpose of writing\nParagraph 2: Provide details and background\nParagraph 3: Request action or give suggestions\n\nI look forward to hearing from you.\nYours faithfully,\n[Your Name]'
                },
                {
                    id: 'eng6',
                    question: 'Informal Email Structure',
                    answer: 'Subject: [Clear and concise subject]\n\nHi [Name],\n\nOpening: "Hope you\'re doing well."\nMain body: "I\'m writing to tell you about..."\nDetails: Use contractions and friendly tone\nClosing: "Let me know what you think."\n\nBest wishes,\n[Your Name]'
                }
            ],
            'é«˜çº§å¥å‹': [
                {
                    id: 'eng7',
                    question: 'Complex Sentence Patterns',
                    answer: '1. Not only... but also... (ä¸ä»…...è€Œä¸”...)\n2. It is universally acknowledged that... (ä¼—æ‰€å‘¨çŸ¥...)\n3. There is no denying that... (ä¸å¯å¦è®¤...)\n4. What matters most is... (æœ€é‡è¦çš„æ˜¯...)\n5. The reason why... is that... (...çš„åŸå› æ˜¯...)\n6. Despite the fact that... (å°½ç®¡...)\n7. As far as I am concerned... (å°±æˆ‘è€Œè¨€...)'
                },
                {
                    id: 'eng8',
                    question: 'Transition Words',
                    answer: 'Addition: Furthermore, Moreover, In addition\nContrast: However, Nevertheless, On the other hand\nCause: Consequently, Therefore, As a result\nExample: For instance, To illustrate, Such as\nSequence: Firstly, Secondly, Finally\nConclusion: In conclusion, To sum up, Overall'
                }
            ]
        }
    }
};

// åº”ç”¨çŠ¶æ€
let database = null;
let firebaseAvailable = false;
let currentUser = null;
let contentData = JSON.parse(JSON.stringify(defaultData));
let learnedItems = [];
let favoriteItems = [];
let currentMode = 'politics';
let currentCategory = 'all';
let currentView = 'card';
let editingItemId = null;
let isOnline = navigator.onLine;
let useLocalMode = false;

// åŠ è½½çŠ¶æ€ç®¡ç†
const loadingOverlay = document.getElementById('loading-overlay');
const loadingStatus = document.getElementById('loading-status');

function showLoading(message) {
    if (loadingStatus) {
        loadingStatus.textContent = message;
    }
}

function hideLoading() {
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

// Firebase SDK åŠ è½½å™¨
class FirebaseLoader {
    async loadFirebaseSDK() {
        showLoading('æ­£åœ¨åŠ è½½ Firebase SDK...');

        try {
            // è®¾ç½®è¶…æ—¶
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶')), 10000);
            });

            // å°è¯•åŠ è½½ Firebase
            await Promise.race([
                this.loadScript('https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js'),
                timeoutPromise
            ]);

            await this.loadScript('https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js');
            await this.loadScript('https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js');

            // ç­‰å¾…è„šæœ¬æ‰§è¡Œ
            await this.delay(1000);

            if (typeof firebase !== 'undefined') {
                showLoading('âœ… Firebase SDK åŠ è½½æˆåŠŸï¼');
                await this.delay(500);
                hideLoading();
                return true;
            } else {
                throw new Error('Firebase æœªæ­£ç¡®åŠ è½½');
            }
        } catch (error) {
            console.error('Firebase åŠ è½½å¤±è´¥:', error);
            showLoading('âš ï¸ Firebase åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
            await this.delay(2000);
            hideLoading();
            return false;
        }
    }

    loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;

            script.onload = resolve;
            script.onerror = reject;

            document.head.appendChild(script);
        });
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// åˆå§‹åŒ– Firebase åŠ è½½å™¨
const firebaseLoader = new FirebaseLoader();

// é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åŠ è½½ Firebase
window.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨');
    
    // è®¾ç½®ä¸€ä¸ªæ€»è¶…æ—¶ï¼Œç¡®ä¿åº”ç”¨ä¸ä¼šä¸€ç›´å¡åœ¨åˆå§‹åŒ–çŠ¶æ€
    const initTimeout = setTimeout(() => {
        console.log('åˆå§‹åŒ–è¶…æ—¶ï¼Œå¼ºåˆ¶éšè—åŠ è½½ç•Œé¢');
        hideLoading();
        initializeApp(true); // å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    }, 15000); // 15ç§’è¶…æ—¶
    
    try {
        const firebaseLoaded = await firebaseLoader.loadFirebaseSDK();
        clearTimeout(initTimeout);
        console.log('åˆå§‹åŒ–åº”ç”¨ï¼ŒFirebase å¯ç”¨:', firebaseLoaded);
        initializeApp(!firebaseLoaded);
    } catch (error) {
        clearTimeout(initTimeout);
        console.error('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
        hideLoading();
        initializeApp(true); // å‡ºé”™æ—¶ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    }
});

function initializeApp(firebaseOnly = false) {
    // ç¡®ä¿åŠ è½½é®ç½©è¢«éšè—
    hideLoading();
    
    // åˆå§‹åŒ– Firebase
    if (!firebaseOnly && typeof firebase !== 'undefined') {
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            firebaseAvailable = true;
            console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('Firebase åˆå§‹åŒ–å¤±è´¥:', error);
        }
    } else {
        console.log('Firebase ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
    }

    // ç¡®ä¿ç™»å½•ç•Œé¢å¯è§
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    
    if (loginContainer) {
        loginContainer.style.display = 'flex';
    }
    
    if (appContainer) {
        appContainer.style.display = 'none';
    }

    // å¦‚æœ Firebase ä¸å¯ç”¨ï¼Œé»˜è®¤ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    if (!firebaseAvailable) {
        const useLocalCheckbox = document.getElementById('use-local');
        if (useLocalCheckbox) {
            useLocalCheckbox.checked = true;
            useLocalCheckbox.disabled = true;
        }
        useLocalMode = true;
    }

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
    initializeEventListeners();
}

function initializeEventListeners() {
    // ç™»å½•è¡¨å•
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }

    // é€€å‡ºç™»å½•
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }

    // æ‰‹åŠ¨åŒæ­¥
    const syncBtn = document.getElementById('sync-btn');
    if (syncBtn) {
        syncBtn.addEventListener('click', handleSync);
    }

    // å¯¼å‡ºæ•°æ®
    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', showExportModal);
    }

    // æ·»åŠ è¡¨å•
    const addForm = document.getElementById('add-form');
    if (addForm) {
        addForm.addEventListener('submit', saveItem);
    }

    // æ¨¡æ€æ¡†å…³é—­
    const closeModalBtn = document.getElementById('close-modal-btn');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeAddModal);
    }

    const closeExportModalBtn = document.getElementById('close-export-modal-btn');
    if (closeExportModalBtn) {
        closeExportModalBtn.addEventListener('click', hideExportModal);
    }

    // åˆ†ç±»é€‰æ‹©å˜åŒ–
    const itemCategory = document.getElementById('item-category');
    if (itemCategory) {
        itemCategory.addEventListener('change', function() {
            const newCategoryInput = document.getElementById('new-category');
            if (this.value === 'new') {
                newCategoryInput.style.display = 'block';
                newCategoryInput.required = true;
            } else {
                newCategoryInput.style.display = 'none';
                newCategoryInput.required = false;
            }
        });
    }

    // ESC é”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeAddModal();
            hideExportModal();
        }
    });

    // ç½‘ç»œçŠ¶æ€ç›‘å¬
    window.addEventListener('online', () => {
        isOnline = true;
        showSyncStatus('ç½‘ç»œå·²è¿æ¥', 2000);
    });

    window.addEventListener('offline', () => {
        isOnline = false;
        showSyncStatus('ç½‘ç»œå·²æ–­å¼€', 2000);
    });
}

// ç™»å½•å¤„ç†
async function handleLogin(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const useLocalCheckbox = document.getElementById('use-local');
    
    useLocalMode = useLocalCheckbox.checked || !firebaseAvailable;

    if (!username || !password) {
        showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }

    const hashedPassword = hashPassword(password);

    try {
        const loginText = document.getElementById('login-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginBtn = document.getElementById('login-btn');

        if (loginText) loginText.style.display = 'none';
        if (loginSpinner) loginSpinner.style.display = 'inline-block';
        if (loginBtn) loginBtn.disabled = true;

        showSyncStatus('ç™»å½•ä¸­...');
        console.log(`å°è¯•ç™»å½•ç”¨æˆ·: ${username}, ä½¿ç”¨æœ¬åœ°æ¨¡å¼: ${useLocalMode}`);

        if (useLocalMode) {
            // æœ¬åœ°å­˜å‚¨æ¨¡å¼
            currentUser = username;
            contentData = JSON.parse(localStorage.getItem('content_' + username)) || JSON.parse(JSON.stringify(defaultData));
            learnedItems = JSON.parse(localStorage.getItem('learned_' + username)) || [];
            favoriteItems = JSON.parse(localStorage.getItem('favorites_' + username)) || [];
            console.log('æœ¬åœ°å­˜å‚¨æ¨¡å¼ç™»å½•æˆåŠŸ');
            showApp();
        } else {
            // äº‘ç«¯æ¨¡å¼
            if (!database) {
                throw new Error('Firebase æœªåˆå§‹åŒ–');
            }

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            const userRef = database.ref('users/' + username);
            const snapshot = await userRef.once('value');

            if (snapshot.exists()) {
                // ç”¨æˆ·å­˜åœ¨ï¼ŒéªŒè¯å¯†ç 
                const userData = snapshot.val();
                if (userData.password === hashedPassword) {
                    currentUser = username;
                    await loadUserData();
                    showApp();
                } else {
                    showToast('å¯†ç é”™è¯¯');
                }
            } else {
                // æ–°ç”¨æˆ·ï¼Œåˆ›å»ºè´¦æˆ·
                await userRef.set({
                    password: hashedPassword,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                currentUser = username;
                contentData = JSON.parse(JSON.stringify(defaultData));
                learnedItems = [];
                favoriteItems = [];
                await saveUserData();
                showApp();
            }
        }
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);

        // å¦‚æœäº‘ç«¯å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼
        if (!useLocalMode) {
            const useLocalFallback = confirm(
                `äº‘ç«¯ç™»å½•å¤±è´¥: ${error.message}\n\næ˜¯å¦ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Ÿ\nï¼ˆæ•°æ®å°†ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œæ— æ³•è·¨è®¾å¤‡åŒæ­¥ï¼‰`
            );

            if (useLocalFallback) {
                useLocalMode = true;
                const useLocalCheckbox = document.getElementById('use-local');
                if (useLocalCheckbox) {
                    useLocalCheckbox.checked = true;
                }
                currentUser = username;
                contentData = JSON.parse(localStorage.getItem('content_' + username)) || JSON.parse(JSON.stringify(defaultData));
                learnedItems = JSON.parse(localStorage.getItem('learned_' + username)) || [];
                favoriteItems = JSON.parse(localStorage.getItem('favorites_' + username)) || [];
                showApp();
            } else {
                showToast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } else {
            showToast('ç™»å½•å¤±è´¥: ' + error.message);
        }
    } finally {
        const loginText = document.getElementById('login-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginBtn = document.getElementById('login-btn');

        if (loginText) loginText.style.display = 'inline';
        if (loginSpinner) loginSpinner.style.display = 'none';
        if (loginBtn) loginBtn.disabled = false;
        showSyncStatus('');
    }
}

// é€€å‡ºç™»å½•
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        currentUser = null;
        contentData = JSON.parse(JSON.stringify(defaultData));
        learnedItems = [];
        favoriteItems = [];
        
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const useLocalCheckbox = document.getElementById('use-local');
        
        if (loginContainer) loginContainer.style.display = 'flex';
        if (appContainer) appContainer.style.display = 'none';
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
        if (useLocalCheckbox) useLocalCheckbox.checked = false;
    }
}

// æ‰‹åŠ¨åŒæ­¥
async function handleSync() {
    if (useLocalMode || !firebaseAvailable) {
        showSyncStatus('æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Œæ— éœ€åŒæ­¥', 2000);
        return;
    }

    if (!isOnline) {
        showSyncStatus('ç½‘ç»œæœªè¿æ¥', 2000);
        return;
    }
    await saveUserData();
}

// æ˜¾ç¤ºä¸»åº”ç”¨
function showApp() {
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const currentUserSpan = document.getElementById('current-user');
    
    if (loginContainer) loginContainer.style.display = 'none';
    if (appContainer) appContainer.style.display = 'block';
    if (currentUserSpan) {
        currentUserSpan.textContent = currentUser + (useLocalMode || !firebaseAvailable ? ' (æœ¬åœ°æ¨¡å¼)' : '');
    }
    
    // åˆå§‹åŒ–åº”ç”¨ç•Œé¢
    loadCategories();
    loadContent();
    updateStats();
    updateProgress();
    loadFavorites();
}

// åŠ è½½ç”¨æˆ·æ•°æ®
async function loadUserData() {
    if (!currentUser) return;

    if (useLocalMode || !firebaseAvailable) {
        contentData = JSON.parse(localStorage.getItem('content_' + currentUser)) || JSON.parse(JSON.stringify(defaultData));
        learnedItems = JSON.parse(localStorage.getItem('learned_' + currentUser)) || [];
        favoriteItems = JSON.parse(localStorage.getItem('favorites_' + currentUser)) || [];
        return;
    }

    try {
        showSyncStatus('åŠ è½½æ•°æ®...');
        
        // åŠ è½½å†…å®¹æ•°æ®
        const contentRef = database.ref('content/' + currentUser);
        const contentSnapshot = await contentRef.once('value');
        if (contentSnapshot.exists()) {
            contentData = contentSnapshot.val();
        } else {
            contentData = JSON.parse(JSON.stringify(defaultData));
        }
        
        // åŠ è½½å­¦ä¹ çŠ¶æ€
        const learnedRef = database.ref('learned/' + currentUser);
        const learnedSnapshot = await learnedRef.once('value');
        if (learnedSnapshot.exists()) {
            learnedItems = learnedSnapshot.val();
        } else {
            learnedItems = [];
        }
        
        // åŠ è½½æ”¶è—æ•°æ®
        const favoritesRef = database.ref('favorites/' + currentUser);
        const favoritesSnapshot = await favoritesRef.once('value');
        if (favoritesSnapshot.exists()) {
            favoriteItems = favoritesSnapshot.val();
        } else {
            favoriteItems = [];
        }

        // æ›´æ–°æœ€åç™»å½•æ—¶é—´
        database.ref('users/' + currentUser + '/lastLogin').set(new Date().toISOString());
    } catch (error) {
        console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
        showSyncStatus('åŠ è½½æ•°æ®å¤±è´¥', 2000);
    }
}

// ä¿å­˜ç”¨æˆ·æ•°æ®
async function saveUserData() {
    if (!currentUser) return;

    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('content_' + currentUser, JSON.stringify(contentData));
        localStorage.setItem('learned_' + currentUser, JSON.stringify(learnedItems));
        localStorage.setItem('favorites_' + currentUser, JSON.stringify(favoriteItems));
        showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
        return;
    }

    try {
        const syncText = document.getElementById('sync-text');
        const syncSpinner = document.getElementById('sync-spinner');
        
        if (syncText) syncText.style.display = 'none';
        if (syncSpinner) syncSpinner.style.display = 'inline-block';
        showSyncStatus('ä¿å­˜ä¸­...');

        // ä¿å­˜å†…å®¹æ•°æ®
        await database.ref('content/' + currentUser).set(contentData);
        
        // ä¿å­˜å­¦ä¹ çŠ¶æ€
        await database.ref('learned/' + currentUser).set(learnedItems);
        
        // ä¿å­˜æ”¶è—æ•°æ®
        await database.ref('favorites/' + currentUser).set(favoriteItems);
        
        showSyncStatus('å·²åŒæ­¥åˆ°äº‘ç«¯', 1500);
    } catch (error) {
        console.error('ä¿å­˜æ•°æ®é”™è¯¯:', error);
        showSyncStatus('åŒæ­¥å¤±è´¥', 2000);
    } finally {
        const syncText = document.getElementById('sync-text');
        const syncSpinner = document.getElementById('sync-spinner');
        
        if (syncText) syncText.style.display = 'inline';
        if (syncSpinner) syncSpinner.style.display = 'none';
    }
}

// åˆ‡æ¢æ¨¡å¼
function switchMode(mode) {
    currentMode = mode;
    currentCategory = 'all';
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (mode === 'politics') {
        document.getElementById('politics-mode-btn').classList.add('active');
    } else {
        document.getElementById('english-mode-btn').classList.add('active');
    }
    
    // é‡æ–°åŠ è½½å†…å®¹
    loadCategories();
    loadContent();
    updateStats();
    updateProgress();
    loadFavorites();
    
    showToast(`å·²åˆ‡æ¢åˆ°${mode === 'politics' ? 'æ”¿æ²»åˆ†æ' : 'è‹±è¯­ä½œæ–‡'}æ¨¡å¼`);
}

// åŠ è½½åˆ†ç±»
function loadCategories() {
    const categoryList = document.getElementById('category-list');
    const categories = contentData[currentMode].categories;
    
    let html = `
        <li class="category-item ${currentCategory === 'all' ? 'active' : ''}" onclick="selectCategory('all')">
            <span>å…¨éƒ¨é¢˜ç›®</span>
            <span class="category-count">${getAllItemsCount()}</span>
        </li>
    `;
    
    for (const [category, items] of Object.entries(categories)) {
        const isCustom = category.startsWith('custom_');
        html += `
            <li class="category-item ${isCustom ? 'custom' : ''} ${currentCategory === category ? 'active' : ''}" onclick="selectCategory('${category}')">
                <span>${isCustom ? category.replace('custom_', '') : category}</span>
                <span class="category-count">${items.length}</span>
                ${isCustom ? `<span class="delete-category" onclick="event.stopPropagation(); deleteCategory('${category}')">ğŸ—‘ï¸</span>` : ''}
            </li>
        `;
    }
    
    categoryList.innerHTML = html;
}

// è·å–æ‰€æœ‰é¢˜ç›®æ•°é‡
function getAllItemsCount() {
    const categories = contentData[currentMode].categories;
    return Object.values(categories).reduce((total, items) => total + items.length, 0);
}

// é€‰æ‹©åˆ†ç±»
function selectCategory(category) {
    currentCategory = category;
    
    // æ›´æ–°æ´»åŠ¨çŠ¶æ€
    document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // æ›´æ–°æ ‡é¢˜
    document.getElementById('content-title').textContent = 
        category === 'all' ? 'å…¨éƒ¨é¢˜ç›®' : (category.startsWith('custom_') ? category.replace('custom_', '') : category);
    
    // åŠ è½½å†…å®¹
    loadContent();
}

// åŠ è½½å†…å®¹
function loadContent() {
    let items = [];
    
    if (currentCategory === 'all') {
        const categories = contentData[currentMode].categories;
        for (const categoryItems of Object.values(categories)) {
            items = items.concat(categoryItems);
        }
    } else {
        items = contentData[currentMode].categories[currentCategory] || [];
    }
    
    renderContent(items);
}

// æ¸²æŸ“å†…å®¹
function renderContent(items) {
    const cardView = document.getElementById('card-view');
    const listView = document.getElementById('list-view');
    
    // å¡ç‰‡è§†å›¾
    let cardHtml = '';
    items.forEach((item, index) => {
        const isLearned = learnedItems.includes(item.id);
        const isFavorited = favoriteItems.includes(item.id);
        const isCustom = item.id.startsWith('custom_');
        cardHtml += `
            <div class="memory-card ${isCustom ? 'custom' : ''}" onclick="toggleAnswer('${item.id}')" data-id="${item.id}">
                <span class="card-number">#${index + 1}</span>
                <div class="card-question">${item.question}</div>
                <div class="card-answer" id="answer-${item.id}">
                    ${item.answer}
                </div>
                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="action-btn ${isLearned ? 'learned' : ''}" onclick="event.stopPropagation(); toggleLearned('${item.id}')" title="æ ‡è®°å·²å­¦ä¹ ">
                        ${isLearned ? 'âœ…' : 'â­•'}
                    </button>
                    <button class="action-btn ${isFavorited ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite('${item.id}')" title="æ”¶è—">
                        ${isFavorited ? 'â¤ï¸' : 'ğŸ¤'}
                    </button>
                    ${isCustom ? `<button class="action-btn" onclick="event.stopPropagation(); editItem('${item.id}')" title="ç¼–è¾‘">âœï¸</button>` : ''}
                    ${isCustom ? `<button class="action-btn delete" onclick="event.stopPropagation(); deleteItem('${item.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>` : ''}
                </div>
            </div>
        `;
    });
    cardView.innerHTML = cardHtml;
    
    // åˆ—è¡¨è§†å›¾
    let listHtml = '';
    items.forEach((item, index) => {
        const isLearned = learnedItems.includes(item.id);
        const isFavorited = favoriteItems.includes(item.id);
        const isCustom = item.id.startsWith('custom_');
        listHtml += `
            <div class="list-item ${isCustom ? 'custom' : ''}" data-id="${item.id}">
                <div class="list-item-header">
                    <span class="list-item-title">${index + 1}. ${item.question}</span>
                    <div class="action-buttons">
                        <button class="action-btn ${isLearned ? 'learned' : ''}" onclick="toggleLearned('${item.id}')" title="æ ‡è®°å·²å­¦ä¹ ">
                            ${isLearned ? 'âœ…' : 'â­•'}
                        </button>
                        <button class="action-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite('${item.id}')" title="æ”¶è—">
                            ${isFavorited ? 'â¤ï¸' : 'ğŸ¤'}
                        </button>
                        ${isCustom ? `<button class="action-btn" onclick="editItem('${item.id}')" title="ç¼–è¾‘">âœï¸</button>` : ''}
                        ${isCustom ? `<button class="action-btn delete" onclick="deleteItem('${item.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>` : ''}
                    </div>
                </div>
                <div class="list-item-content">
                    ${item.answer}
                </div>
            </div>
        `;
    });
    listView.innerHTML = listHtml;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºå±•å¼€/æ”¶èµ·åˆ—è¡¨é¡¹
    document.querySelectorAll('.list-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (!e.target.classList.contains('action-btn')) {
                this.classList.toggle('expanded');
            }
        });
    });
}

// åˆ‡æ¢ç­”æ¡ˆæ˜¾ç¤º
function toggleAnswer(itemId) {
    const answer = document.getElementById(`answer-${itemId}`);
    answer.classList.toggle('show');
}

// åˆ‡æ¢å­¦ä¹ çŠ¶æ€
async function toggleLearned(itemId) {
    const index = learnedItems.indexOf(itemId);
    if (index > -1) {
        learnedItems.splice(index, 1);
        showToast('å·²å–æ¶ˆå­¦ä¹ æ ‡è®°');
    } else {
        learnedItems.push(itemId);
        showToast('å·²æ ‡è®°ä¸ºå·²å­¦ä¹ ');
    }
    
    // ä¿å­˜æ•°æ®
    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('learned_' + currentUser, JSON.stringify(learnedItems));
    } else {
        if (isOnline) {
            await saveUserData();
        } else {
            showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
        }
    }
    
    updateStats();
    updateProgress();
    loadContent();
}

// åˆ‡æ¢æ”¶è—çŠ¶æ€
async function toggleFavorite(itemId) {
    const index = favoriteItems.indexOf(itemId);
    if (index > -1) {
        favoriteItems.splice(index, 1);
        showToast('å·²å–æ¶ˆæ”¶è—');
    } else {
        favoriteItems.push(itemId);
        showToast('å·²æ·»åŠ åˆ°æ”¶è—å¤¹');
    }
    
    // ä¿å­˜æ•°æ®
    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('favorites_' + currentUser, JSON.stringify(favoriteItems));
    } else {
        if (isOnline) {
            await saveUserData();
        } else {
            showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
        }
    }
    
    updateStats();
    loadContent();
    loadFavorites();
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats() {
    const totalItems = getAllItemsCount();
    const learnedCount = learnedItems.filter(id => {
        for (const category of Object.values(contentData[currentMode].categories)) {
            if (category.some(item => item.id === id)) {
                return true;
            }
        }
        return false;
    }).length;
    
    const favoriteCount = favoriteItems.filter(id => {
        for (const category of Object.values(contentData[currentMode].categories)) {
            if (category.some(item => item.id === id)) {
                return true;
            }
        }
        return false;
    }).length;
    
    document.getElementById('total-items').textContent = totalItems;
    document.getElementById('learned-items').textContent = learnedCount;
    document.getElementById('favorite-items').textContent = favoriteCount;
    
    const percentage = totalItems > 0 ? Math.round((learnedCount / totalItems) * 100) : 0;
    document.getElementById('progress-percent').textContent = percentage + '%';
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgress() {
    const totalItems = getAllItemsCount();
    const learnedCount = learnedItems.filter(id => {
        for (const category of Object.values(contentData[currentMode].categories)) {
            if (category.some(item => item.id === id)) {
                return true;
            }
        }
        return false;
    }).length;
    
    const percentage = totalItems > 0 ? Math.round((learnedCount / totalItems) * 100) : 0;
    
    document.getElementById('progress-bar').style.width = percentage + '%';
    document.getElementById('progress-text').textContent = `${percentage}% å®Œæˆ (${learnedCount}/${totalItems})`;
}

// åŠ è½½æ”¶è—å¤¹
function loadFavorites() {
    const container = document.getElementById('favorites-container');
    const favorites = favoriteItems.filter(id => {
        for (const category of Object.values(contentData[currentMode].categories)) {
            if (category.some(item => item.id === id)) {
                return true;
            }
        }
        return false;
    });
    
    if (favorites.length === 0) {
        container.innerHTML = '<div style="color: #999; text-align: center;">æš‚æ— æ”¶è—</div>';
        return;
    }
    
    let html = '';
    favorites.forEach(id => {
        // æŸ¥æ‰¾é¡¹ç›®
        let item = null;
        for (const category of Object.values(contentData[currentMode].categories)) {
            const found = category.find(i => i.id === id);
            if (found) {
                item = found;
                break;
            }
        }
        
        if (item) {
            html += `
                <div class="favorite-item" onclick="scrollToItem('${id}')">
                    ${item.question.substring(0, 30)}...
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

// æ»šåŠ¨åˆ°ç‰¹å®šé¡¹ç›®
function scrollToItem(itemId) {
    const card = document.querySelector(`[data-id="${itemId}"]`);
    if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        card.style.animation = 'pulse 1s';
        setTimeout(() => {
            card.style.animation = '';
        }, 1000);
    }
}

// åˆ‡æ¢è§†å›¾æ¨¡å¼
function toggleView(view) {
    currentView = view;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // åˆ‡æ¢è§†å›¾
    if (view === 'card') {
        document.getElementById('card-view').style.display = 'grid';
        document.getElementById('list-view').style.display = 'none';
    } else {
        document.getElementById('card-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'block';
    }
}

// æœç´¢é¡¹ç›®
function searchItems(query) {
    if (!query) {
        loadContent();
        return;
    }
    
    query = query.toLowerCase();
    let items = [];
    
    if (currentCategory === 'all') {
        const categories = contentData[currentMode].categories;
        for (const categoryItems of Object.values(categories)) {
            items = items.concat(categoryItems);
        }
    } else {
        items = contentData[currentMode].categories[currentCategory] || [];
    }
    
    const filtered = items.filter(item => 
        item.question.toLowerCase().includes(query) ||
        item.answer.toLowerCase().includes(query)
    );
    
    renderContent(filtered);
}

// éšæœºå¤ä¹ 
function randomReview() {
    let items = [];
    
    if (currentCategory === 'all') {
        const categories = contentData[currentMode].categories;
        for (const categoryItems of Object.values(categories)) {
            items = items.concat(categoryItems);
        }
    } else {
        items = contentData[currentMode].categories[currentCategory] || [];
    }
    
    if (items.length === 0) {
        showToast('æ²¡æœ‰å¯å¤ä¹ çš„é¢˜ç›®');
        return;
    }
    
    const randomItem = items[Math.floor(Math.random() * items.length)];
    scrollToItem(randomItem.id);
    
    // 3ç§’åè‡ªåŠ¨æ˜¾ç¤ºç­”æ¡ˆ
    setTimeout(() => {
        const answer = document.getElementById(`answer-${randomItem.id}`);
        if (answer && !answer.classList.contains('show')) {
            answer.classList.add('show');
        }
    }, 3000);
}

// æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
function openAddModal() {
    document.getElementById('add-modal').classList.add('show');
    document.getElementById('modal-title').textContent = 'æ·»åŠ æ–°é¢˜ç›®';
    document.getElementById('add-form').reset();
    editingItemId = null;
    updateCategoryOptions();
}

// å…³é—­æ·»åŠ æ¨¡æ€æ¡†
function closeAddModal() {
    document.getElementById('add-modal').classList.remove('show');
    editingItemId = null;
}

// æ›´æ–°åˆ†ç±»é€‰é¡¹
function updateCategoryOptions() {
    const itemType = document.getElementById('item-type').value;
    const categorySelect = document.getElementById('item-category');
    const categories = contentData[itemType].categories;
    
    let options = '<option value="">é€‰æ‹©åˆ†ç±»</option><option value="new">+ æ–°å»ºåˆ†ç±»</option>';
    for (const category of Object.keys(categories)) {
        const displayName = category.startsWith('custom_') ? category.replace('custom_', '') : category;
        options += `<option value="${category}">${displayName}</option>`;
    }
    categorySelect.innerHTML = options;
}

// ä¿å­˜é¡¹ç›®
async function saveItem(event) {
    event.preventDefault();
    
    const itemType = document.getElementById('item-type').value;
    const categorySelect = document.getElementById('item-category');
    const newCategoryInput = document.getElementById('new-category');
    let category = categorySelect.value;
    
    if (category === 'new') {
        category = 'custom_' + newCategoryInput.value.trim();
        if (!category.replace('custom_', '')) {
            showToast('è¯·è¾“å…¥åˆ†ç±»åç§°');
            return;
        }
        if (!contentData[itemType].categories[category]) {
            contentData[itemType].categories[category] = [];
        }
    } else if (!category) {
        showToast('è¯·é€‰æ‹©åˆ†ç±»');
        return;
    }
    
    const question = document.getElementById('item-question').value.trim();
    const answer = document.getElementById('item-answer').value.trim();
    
    if (!question || !answer) {
        showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    if (editingItemId) {
        // ç¼–è¾‘ç°æœ‰é¡¹ç›®
        const item = findItemById(editingItemId);
        if (item) {
            item.question = question;
            item.answer = answer;
            showToast('é¢˜ç›®å·²æ›´æ–°');
        }
    } else {
        // æ·»åŠ æ–°é¡¹ç›®
        const newItem = {
            id: 'custom_' + Date.now(),
            question: question,
            answer: answer
        };
        contentData[itemType].categories[category].push(newItem);
        showToast('é¢˜ç›®å·²æ·»åŠ ');
    }
    
    // ä¿å­˜æ•°æ®
    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('content_' + currentUser, JSON.stringify(contentData));
    } else {
        if (isOnline) {
            await saveUserData();
        } else {
            showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
        }
    }
    
    closeAddModal();
    
    // å¦‚æœåœ¨å½“å‰æ¨¡å¼ä¸‹ï¼Œåˆ·æ–°ç•Œé¢
    if (itemType === currentMode) {
        loadCategories();
        loadContent();
        updateStats();
    }
}

// æŸ¥æ‰¾é¡¹ç›®
function findItemById(itemId) {
    for (const mode of ['politics', 'english']) {
        for (const category of Object.values(contentData[mode].categories)) {
            const item = category.find(i => i.id === itemId);
            if (item) return item;
        }
    }
    return null;
}

// ç¼–è¾‘é¡¹ç›®
function editItem(itemId) {
    const item = findItemById(itemId);
    if (!item) return;
    
    editingItemId = itemId;
    document.getElementById('modal-title').textContent = 'ç¼–è¾‘é¢˜ç›®';
    
    // æŸ¥æ‰¾é¡¹ç›®æ‰€å±æ¨¡å¼å’Œåˆ†ç±»
    let itemType = null;
    let category = null;
    for (const mode of ['politics', 'english']) {
        for (const [catName, catItems] of Object.entries(contentData[mode].categories)) {
            if (catItems.some(i => i.id === itemId)) {
                itemType = mode;
                category = catName;
                break;
            }
        }
        if (itemType) break;
    }
    
    if (itemType && category) {
        document.getElementById('item-type').value = itemType;
        updateCategoryOptions();
        document.getElementById('item-category').value = category;
        document.getElementById('item-question').value = item.question;
        document.getElementById('item-answer').value = item.answer;
        
        document.getElementById('add-modal').classList.add('show');
    }
}

// åˆ é™¤é¡¹ç›®
async function deleteItem(itemId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢˜ç›®å—ï¼Ÿ')) return;
    
    for (const mode of ['politics', 'english']) {
        for (const [category, items] of Object.entries(contentData[mode].categories)) {
            const index = items.findIndex(i => i.id === itemId);
            if (index > -1) {
                items.splice(index, 1);
                
                // ä»å­¦ä¹ å’Œæ”¶è—åˆ—è¡¨ä¸­ç§»é™¤
                const learnedIndex = learnedItems.indexOf(itemId);
                if (learnedIndex > -1) learnedItems.splice(learnedIndex, 1);
                
                const favIndex = favoriteItems.indexOf(itemId);
                if (favIndex > -1) favoriteItems.splice(favIndex, -1);
                
                // ä¿å­˜æ•°æ®
                if (useLocalMode || !firebaseAvailable) {
                    localStorage.setItem('content_' + currentUser, JSON.stringify(contentData));
                    localStorage.setItem('learned_' + currentUser, JSON.stringify(learnedItems));
                    localStorage.setItem('favorites_' + currentUser, JSON.stringify(favoriteItems));
                } else {
                    if (isOnline) {
                        await saveUserData();
                    } else {
                        showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
                    }
                }
                
                loadCategories();
                loadContent();
                updateStats();
                loadFavorites();
                showToast('é¢˜ç›®å·²åˆ é™¤');
                return;
            }
        }
    }
}

// åˆ é™¤åˆ†ç±»
async function deleteCategory(categoryName) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»åŠå…¶æ‰€æœ‰é¢˜ç›®å—ï¼Ÿ')) return;
    
    delete contentData[currentMode].categories[categoryName];
    
    // ä»å­¦ä¹ å’Œæ”¶è—åˆ—è¡¨ä¸­ç§»é™¤è¯¥åˆ†ç±»çš„æ‰€æœ‰é¡¹ç›®
    const itemsToDelete = [];
    for (const [cat, items] of Object.entries(contentData[currentMode].categories)) {
        if (cat === categoryName) {
            itemsToDelete.push(...items.map(i => i.id));
        }
    }
    
    learnedItems = learnedItems.filter(id => !itemsToDelete.includes(id));
    favoriteItems = favoriteItems.filter(id => !itemsToDelete.includes(id));
    
    // ä¿å­˜æ•°æ®
    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('content_' + currentUser, JSON.stringify(contentData));
        localStorage.setItem('learned_' + currentUser, JSON.stringify(learnedItems));
        localStorage.setItem('favorites_' + currentUser, JSON.stringify(favoriteItems));
    } else {
        if (isOnline) {
            await saveUserData();
        } else {
            showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
        }
    }
    
    currentCategory = 'all';
    loadCategories();
    loadContent();
    updateStats();
    loadFavorites();
    showToast('åˆ†ç±»å·²åˆ é™¤');
}

// æ˜¾ç¤ºå¯¼å‡ºæ¨¡æ€æ¡†
function showExportModal() {
    const modal = document.getElementById('export-modal');
    const exportOptions = document.getElementById('export-options');
    
    if (!modal || !exportOptions) return;
    
    let html = `
        <div style="margin-bottom: 1rem;">
            <h4 style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">é€‰æ‹©å¯¼å‡ºå†…å®¹</h4>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                    <input type="radio" name="export-option" value="all" checked style="margin-right: 0.5rem;">
                    å¯¼å‡ºå…¨éƒ¨æ•°æ®
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                    <input type="radio" name="export-option" value="politics" style="margin-right: 0.5rem;">
                    ä»…å¯¼å‡ºæ”¿æ²»åˆ†æ
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                    <input type="radio" name="export-option" value="english" style="margin-right: 0.5rem;">
                    ä»…å¯¼å‡ºè‹±è¯­ä½œæ–‡
                </label>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button type="button" class="btn" style="background-color: #e5e7eb; color: #374151;" onclick="hideExportModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="exportData()">å¯¼å‡º</button>
        </div>
    `;
    
    exportOptions.innerHTML = html;
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

// éšè—å¯¼å‡ºæ¨¡æ€æ¡†
function hideExportModal() {
    const modal = document.getElementById('export-modal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// å¯¼å‡ºæ•°æ®
function exportData() {
    const exportOption = document.querySelector('input[name="export-option"]:checked').value;
    let dataToExport = {};
    
    if (exportOption === 'all') {
        dataToExport = {
            content: contentData,
            learned: learnedItems,
            favorites: favoriteItems
        };
    } else if (exportOption === 'politics') {
        dataToExport = {
            content: { politics: contentData.politics },
            learned: learnedItems.filter(id => {
                for (const category of Object.values(contentData.politics.categories)) {
                    if (category.some(item => item.id === id)) {
                        return true;
                    }
                }
                return false;
            }),
            favorites: favoriteItems.filter(id => {
                for (const category of Object.values(contentData.politics.categories)) {
                    if (category.some(item => item.id === id)) {
                        return true;
                    }
                }
                return false;
            })
        };
    } else if (exportOption === 'english') {
        dataToExport = {
            content: { english: contentData.english },
            learned: learnedItems.filter(id => {
                for (const category of Object.values(contentData.english.categories)) {
                    if (category.some(item => item.id === id)) {
                        return true;
                    }
                }
                return false;
            }),
            favorites: favoriteItems.filter(id => {
                for (const category of Object.values(contentData.english.categories)) {
                    if (category.some(item => item.id === id)) {
                        return true;
                    }
                }
                return false;
            })
        };
    }
    
    // åˆ›å»ºå¹¶ä¸‹è½½JSONæ–‡ä»¶
    const dataStr = JSON.stringify(dataToExport, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `æ”¿æ²»è‹±è¯­èƒŒè¯µåŠ©æ‰‹_${exportOption}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    hideExportModal();
    showToast('æ•°æ®å·²å¯¼å‡º');
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message) {
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toast-text');
    
    if (toast && toastText) {
        toastText.textContent = message;
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
}

// æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
function showSyncStatus(message, duration = 2000) {
    const syncStatus = document.getElementById('sync-status');
    const syncStatusText = document.getElementById('sync-status-text');
    
    if (syncStatus && syncStatusText) {
        syncStatusText.textContent = message;
        syncStatus.classList.add('show');
        setTimeout(() => {
            syncStatus.classList.remove('show');
        }, duration);
    }
}

// å¯†ç å“ˆå¸Œ
function hashPassword(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString();
}

// æ·»åŠ è„‰å†²åŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(37, 99, 235, 0.5); }
        100% { transform: scale(1); }
    }
`;
document.head.appendChild(style);

console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
</script>
</body>
</html>